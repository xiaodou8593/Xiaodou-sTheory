# 执行方式：天然的命令输入

执行方式，又称执行环境，是命令运行过程中使用的一系列参数的总称，包括维度、坐标、朝向、执行者、高度h。

每条命令都具有自己的执行方式，不受其它命令干扰，我们将其称为局部性。

execute可以改变命令的执行方式。如果未经过execute改变执行方式，那么子命令的执行方式与父命令的执行方式保持一致，我们将其称为继承性。

命令通过一系列基本表达与执行方式建立联系。由于引入执行维度会使得叙述变得复杂，我们一般忽略维度的不同，默认为主世界。以下为常用的执行方式基本表达。

目标选择器@s即为执行者实体的指代。需要注意的是：执行者可以不是实体，例如命令方块，此时@s会选择失败。

目标选择器参数中dx=,dy=,dz=或是distance=，它们的范围起点由x=,y=,z=确定。但如果x=,y=,z=中的若干个未被指定，其默认值则为执行坐标对应分量的值。

相对坐标系~delta_x ~delta_y ~delta_z的各轴方向与xyz轴一致，而相对坐标系的原点 ~ ~ ~ (又称为执行点)即为执行坐标。**需要特别指出的一点是：许多命令新人会将*执行坐标*与*执行者坐标*的概念混淆，误认为 ~ ~ ~ 就是@s的坐标，这是十分不正确的，必须根据实际情况分析二者的坐标。**

局部坐标系^u ^v ^w的各轴方向由执行朝向确定。u轴方向为执行朝向的左方向，v轴方向为执行朝向的上方向，w轴方向为执行朝向的前方向，可以简记为“左上前”。而局部坐标系的原点 ^ ^ ^ (又称为基准点)，由执行坐标与高度h共同确定：^ ^ ^即为~ ~h ~，或者说基准点位于执行点上方h格高度处。

我们发现，命令中遍布执行方式的身影。所以，确定一条命令的执行环境是非常重要的。以下讲解确定命令执行环境的方法。

## 1. 根据命令执行的源头确定执行方式的初始值。

- 若源头为玩家聊天框，那么执行者是玩家，执行维度是玩家所在维度，执行坐标是玩家坐标(碰撞箱地面中心，即feet的位置，feet与eyes又称为实体的锚点)，执行朝向是玩家朝向，高度h是0。

- 若源头为命令方块，那么执行者是命令方块，执行维度是命令方块所在维度，执行坐标是命令方块的中心点坐标，执行朝向是水平正南(z+方向)，高度h是0。

- 若源头为tick/load函数，那么执行者是服务端，执行维度是主世界，执行坐标是世界出生点，执行朝向是正南，高度h是0。

- 此外还有一些不常用的执行源头(成书、tellraw、告示牌、schedule、进度等)，这里不再列举。

## 2. 根据函数的调用过程中的execute子命令分析执行方式状态转移。

- 执行者可能被as修改为参数指定实体。

- 执行维度可能被in修改为参数指定维度，可能被at修改为参数指定实体所在维度。

- 执行坐标可能被at修改为参数指定实体坐标，可能被positioned as修改为参数指定实体坐标，可能被positioned修改为参数指定坐标，可能被align修改为原执行坐标向下取整后坐标，可能被in进行对应维度的坐标缩放。

- 执行朝向可能被rotated修改为参数指定朝向，可能被rotated as修改为参数指定实体朝向，可能被facing修改为从基准点看向参数指定坐标的朝向，可能被facing entity修改为从基准点看向参数指定锚点的朝向。

- 高度h可能被anchored eyes修改为执行者实体的身高(eyes到feet的距离)，可能被anchored feet修改为0，可能被positioned `<pos>` (而at和positioned as无此效果)修改为0。

:::details 对rotated与facing以及tp细节的说明

读者可能遇到过这样一个问题：让一个实体看向反方向。
如果使用命令`execute as entity at @s run tp @s ~ ~ ~ ~ ~180.0`或者命令`execute as entity at @s rotated ~ ~180.0 run tp @s ~ ~ ~ ~ ~`会发现实体并没有看向反方向，而是看向了竖直向上或向下方向。

经过我们的研究发现，问题出现在tp而不是rotated。tp有这样一个机制：当它旋转实体的rot1角的时候，如果我们给tp传入的目标角度超过了-90度到90度的范围，那么实体朝向在旋转过程中会在竖直方向被卡住。例如：实体当前朝向是89.0f，目标角度是91.0f，实体朝向最终会变成90.0f，也就是朝向竖直向下。如果是-89.0f旋转到-91.0f，朝向竖直向上同理。

对于这个现象，我们的解决方法是利用`facing ^ ^ ^1`对执行朝向进行“规整化”。facing的作用是为执行朝向重新赋值，它是标准的-90.0f到90.0f的rot1角度。例如rotated把执行朝向累加到(0.0f,91.0f)后，facing ^ ^ ^1会把执行朝向规整化为(-180.0f,89.0f)，二者是同一个方向，但后者就可以保证tp的正常运行了。类似的道理，我们可以直接使用子命令facing ^ ^ ^-1对执行朝向进行反转。

:::

这是一个利用执行方式实现命令输入的例子：`setblock ~ ~5 ~ stone` 该命令接收执行坐标作为输入，在执行坐标上方5格输出一个石头。（为了简化叙述，忽略了维度、区块加载、高度上限、原有方块）

总结：执行方式是一种天然的、方便、良好的输入。它具有局部性、继承性、可直接访问的优良特性。而执行方式同时具有很大的局限性：

* 单向传递，无法作为命令的输出
* 无法直接进行复杂的数值运算
* 无法表示具有复杂结构的数据

由于以上三点局限性，我们有必要维护更加高级的命令输入输出形式。